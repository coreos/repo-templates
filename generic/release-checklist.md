---
# Template generated by https://github.com/coreos/repo-templates; do not edit downstream
---

# Release process

The release process follows the usual PR-and-review flow, allowing an external reviewer to have a final check before publishing.

## Requirements

This guide requires:

 * A web browser (and network connectivity)
 * `git`
 * [GPG setup][GPG setup] and personal key for signing
 * Write access to this GitHub project

## Release checklist

These steps show how to release version `x.y.z` on the `origin` remote (this can be checked via `git remote -av`).
Push access to the upstream repository is required in order to publish the new tag and the PR branch.

:warning:: if `origin` is not the name of the locally configured remote that points to the upstream git repository (i.e. `git@github.com:coreos/{{ git_repo }}.git`), be sure to assign the correct remote name to the `UPSTREAM_REMOTE` variable.

- make sure the project is clean and prepare the environment:
  - [ ] `git clean -fd`
  - [ ] `RELEASE_VER=x.y.z`
  - [ ] `PREVIOUS_RELEASE_VER=x.y.z-1`
  - [ ] `UPSTREAM_REMOTE=origin`

- write release notes on a dedicated branch and tag it (the commit and tag will be signed with the GPG signing key you configured):
  - [ ] `git checkout -b release-${RELEASE_VER}`
  - [ ] write release notes in `docs/release-notes.md`. You can follow the following template:
    ```
    cat <<EOF > release-notes.txt
    This is release ${NEWTAG} of console-login-helper-messages.

    Thanks to the following contributors for patches during this release:

    $(git shortlog --no-merges --pretty=format:"%h %s" -e ${PREVIOUS_RELEASE_VER}..HEAD)
    EOF
    ```
  - [ ] commit your changes and create the tag:
    ```
    git tag --file release-notes.txt -s "v${RELEASE_VER}"
    ```
  - [ ] verify the tag and its signature:
    ```
    git show "v${RELEASE_VER}"
    git tag --verify "v${RELEASE_VER}"
    ```

- open and merge a PR for this release:
  - [ ] `git push --tags ${UPSTREAM_REMOTE} release-${RELEASE_VER}`
  - [ ] open a web browser and create a PR for the branch above
  - [ ] make sure the resulting PR contains exactly one commit with the release notes
  - [ ] get the PR reviewed, approved and merged

- publish this release on GitHub:
  - [ ] find the new tag in the [GitHub tag list](https://github.com/coreos/{{ git_repo }}/tags), click the triple dots menu, and create a release for it
  - [ ] copy in the changelog from the release notes doc
  - [ ] publish release

- clean up the local environment (optional, but recommended):
  - [ ] `git checkout main`
  - [ ] `git pull ${UPSTREAM_REMOTE} main`
  - [ ] `git push ${UPSTREAM_REMOTE} :release-${RELEASE_VER}`
  - [ ] `git branch -d release-${RELEASE_VER}`

- Fedora packaging:
  - [ ] update the `{{ fedora_package }}` spec file in [Fedora](https://src.fedoraproject.org/rpms/{{ fedora_package }})
    - bump the `Version`
    - switch the `Release` back to `1%{?dist}`
    - remove any patches obsoleted by the new release
    - update changelog
  - [ ] run `spectool -g -S {{ fedora_package }}.spec`
  - [ ] run `kinit your_fas_account@FEDORAPROJECT.ORG`
  - [ ] run `fedpkg new-sources $(spectool -S {{ fedora_package }}.spec | sed 's:.*/::')`
  - [ ] PR the changes in [Fedora](https://src.fedoraproject.org/rpms/{{ fedora_package }})
  - [ ] once the PR merges to rawhide, merge rawhide into the other relevant branches (e.g. f35) then push those, for example:
    ```bash
    git checkout rawhide
    git pull --ff-only
    git checkout f35
    git merge --ff-only rawhide
    git push origin f35
    ```
  - [ ] on each of those branches run `fedpkg build`
  - [ ] once the builds have finished, submit them to [bodhi](https://bodhi.fedoraproject.org/updates/new), filling in:
    - `{{ fedora_package }}` for `Packages`
    - selecting the build(s) that just completed, except for the rawhide one (which gets submitted automatically)
    - writing brief release notes like "New upstream release; see release notes at `link to GitHub release`"
    - leave `Update name` blank
    - `Type`, `Severity` and `Suggestion` can be left as `unspecified` unless it is a security release. In that case select `security` with the appropriate severity.
    - `Stable karma` and `Unstable` karma can be set to `2` and `-1`, respectively.
{%- if do_fast_track %}
  - [ ] [submit a fast-track](https://github.com/coreos/fedora-coreos-config/actions/workflows/add-override.yml) for FCOS testing-devel
  - [ ] [submit a fast-track](https://github.com/coreos/fedora-coreos-config/actions/workflows/add-override.yml) for FCOS next-devel if it is [open](https://github.com/coreos/fedora-coreos-pipeline/blob/main/next-devel/README.md)
{% endif %}

{% if rhel9_package %}
CentOS Stream 9 packaging:
  - [ ] Create a `rebase-c9s-{{ git_repo }}` issue in the internal team-operations repo and follow the steps there
{% endif %}

[GPG setup]: https://docs.github.com/en/github/authenticating-to-github/managing-commit-signature-verification
